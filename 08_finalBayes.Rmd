# Becoming a proud Bayesian

For our finalized Bayesian model, we intend to build predictive models for universities and liberal arts colleges. Then we'll compare the similarities and differences of the two models. (i.e. is some factor important for universities and less so for liberal arts colleges?)

## University Model

### Get some intuition

We could build bi-variate visualizations that help us understand the individual trends: 

```{r echo = FALSE, message = FALSE, warning=FALSE}
c1 <- ggplot(fullUniversity, aes(x = UGDS_1617, y = as.numeric(Y2018))) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylim(1,120) +
  xlab("Undergraduate student size") +
  ylab("School Ranking 2018") +
  ggtitle("Universities")

c2 <- ggplot(fullUniversity, aes(x = SAT_AVG_1617, y = as.numeric(Y2018))) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylim(1,120) +
  xlab("Average SAT score") +
  ylab("School Ranking 2018")
  
c3 <- ggplot(fullUniversity, aes(x = ADM_RATE_1617, y = as.numeric(Y2018))) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylim(1,120) +
  xlab("Admission rate") +
  ylab("School Ranking 2018")

grid.arrange(c1,c2,c3,nrow = 2)
```

### Some additional intuition

For more intuition, we start with more vague priors and slightly adjust the priors based on the summary table. It's important to note that the priors cannot be set too close to the means of the summary table in case of **overfitting**.

### Building the model

```{r}
university_model_3 <- "model{  
    # Data: observations
    for(i in 1:length(y)) {
        y[i] ~ dpois(lambda[i])
        log(lambda[i]) = beta0 + beta1*x1[i] + beta2[z[i]] + beta3*x3[i] + beta4*x4[i]
    }
        # Data: subjects
        beta0 ~ dnorm(8, 1)
        beta1 ~ dnorm(0, 10000)
        beta2[1] <- 0 
        beta2[2] ~ dnorm(0, 0.01)
        beta2[3] ~ dnorm(0, 0.01)
        beta3 ~ dnorm(0, 10)
        beta4 ~ dnorm(0, 0.01)

}"

# COMPILE

y <- as.numeric(fullUniversity$Y2018)

model_data9 <- data.frame(y, x1 = fullUniversity$UGDS_1617, z = as.numeric(fullUniversity$LOCALE_collapse), x3 = fullUniversity$SAT_AVG_1617, x4 = fullUniversity$ADM_RATE_1617)

model_data9 <- na.omit(model_data9)

university_jags_3 <- jags.model(textConnection(university_model_3), 
    data = list(y = model_data9$y, x1 = model_data9$x1, z = factor(model_data9$z), x3 = model_data9$x3, x4 = model_data9$x4),
    inits=list(.RNG.name = "base::Wichmann-Hill", .RNG.seed = 454))

# SIMULATE the model
university_sim_3 <- coda.samples(university_jags_3,
    variable.names = c("beta0","beta1","beta2","beta3","beta4"),
    n.iter = 10000)

# STORE the chains in a data frame
university_chains_3 <- data.frame(university_sim_3[[1]])
```


### Model summary

```{r}
summary(university_sim_3)
```


### Posterior inference

For an unknown university located in the city with 10000 undergraduates, student mean SAT score of 1400 and an admission rate of $25\%$ (e.g. Gvictor University), we could predict its ranking from our rjags simulation.

```{r}
university_chains_3 <- university_chains_3 %>%
  mutate(ranking_new = rpois(10000, lambda = exp(beta0 + beta1 * 10000 + beta3 * 1400 + beta4 * 0.25)))

university_chains_3 %>%
  summarize(quantile(ranking_new,0.025),quantile(ranking_new,0.975))
```

The interval is more reflective of the intuitive estimate of Gvictor University's ranking.

## Liberal Arts Colleges

### Get some intuition

Similar to what we do with universities, we could build bi-variate visualizations that help us understand the individual trends: 

```{r echo = FALSE, warning = FALSE, message=FALSE}
d1 <- ggplot(full_LiberalArts, aes(x = UGDS_1617, y = as.numeric(Y2018))) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylim(1,150) +
  xlab("Undergraduate student size") +
  ylab("School Ranking 2018") +
  ggtitle("Liberal Arts Colleges")

d2 <- ggplot(full_LiberalArts, aes(x = SAT_AVG_1617, y = as.numeric(Y2018))) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylim(1,150) +
  xlab("Average SAT score") +
  ylab("School Ranking 2018")
  
d3 <- ggplot(full_LiberalArts, aes(x = ADM_RATE_1617, y = as.numeric(Y2018))) +
  geom_point() +
  geom_smooth(method = "lm") +
  ylim(1,150) +
  xlab("Admission rate") +
  ylab("School Ranking 2018")

grid.arrange(d1,d2,d3,nrow = 2)
```



### Building the model


```{r message=FALSE, warning=FALSE}
liberal_model_3 <- "model{  
    # Data: observations
    for(i in 1:length(y)) {
        y[i] ~ dpois(lambda[i])
        log(lambda[i]) = beta0 + beta1*x1[i] + beta2[z[i]] + beta3*x3[i] + beta4*x4[i]
    }
    # Data: subjects
    beta0 ~ dnorm(0, 0.0001)
    beta1 ~ dnorm(0, 10000)
    beta2[1] <- 0 
    beta2[2] ~ dnorm(0, 0.04)
    beta2[3] ~ dnorm(-10, 0.04)
    beta2[4] ~ dnorm(-15, 0.01)
    beta3 ~ dnorm(-0.3, 100)
    beta4 ~ dnorm(36, 10)

}"

# COMPILE

y <- as.numeric(full_LiberalArts$Y2018)

model_data8 <- data.frame(y, x1 = as.numeric(full_LiberalArts$UGDS_1617), z = as.numeric(full_LiberalArts$LOCALE_collapse_lac1), x3 = as.numeric(full_LiberalArts$SAT_AVG_1617), x4 = as.numeric(full_LiberalArts$ADM_RATE_1617))

model_data8 <- na.omit(model_data8)

liberal_jags_3 <- jags.model(textConnection(liberal_model_3), 
    data = list(y = model_data8$y, x1 = model_data8$x1, z = factor(model_data8$z), x3 = model_data8$x3, x4 = model_data8$x4),
    inits=list(.RNG.name = "base::Wichmann-Hill", .RNG.seed = 454))

# SIMULATE the model
liberal_sim_3 <- coda.samples(liberal_jags_3,
    variable.names = c("beta0","beta1","beta2","beta3","beta4"),
    n.iter = 10000)

# STORE the chains in a data frame
liberal_chains_3 <- data.frame(liberal_sim_3[[1]])
```

### Model summary

```{r}
summary(liberal_sim_3)
```


### Posterior inference

For an unknown liberal arts college in a rural setting with 2000 undergraduates, student mean SAT score of 1400 and an admission rate of $25\%$ (e.g. Hvictor College), we could predict its ranking from our rjags simulation.

```{r}
liberal_chains_3 <- liberal_chains_3 %>%
  mutate(ranking_new = rpois(10000, exp(beta0 + beta1 * 2000 + beta2.4. + beta3 * 1400 + beta4 * 0.25)))

liberal_chains_3 %>%
  summarize(quantile(ranking_new,0.025),quantile(ranking_new,0.975))
```

This is **totally reasonable**! The interval roughly reflects the intuitive estimate of Hvictor College's ranking.

## Comparison and discussion

Compared to the last attempts, our final model gives reasonable predictions, which is a huge progress! However, the 95% credible interval it provides doesn't provide an accurate enough interval as desired.

By creating different imaginery universities and colleges, we are able to summarize the most important factors for universities and colleges respectively. We find that universities value SAT score as a more decisive indicator of both students' admission and their own ranking.


